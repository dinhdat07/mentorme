generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TUTOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
}

enum ClassStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LocationType {
  ONLINE
  AT_STUDENT
  AT_TUTOR
}

enum BookingStatus {
  PENDING
  CONFIRMED
  TRIAL
  CANCELLED
  COMPLETED
}

enum CancelledBy {
  STUDENT
  TUTOR
  SYSTEM
}

model User {
  id          String          @id @default(uuid())
  fullName    String
  email       String          @unique
  phone       String          @unique
  passwordHash String
  role        UserRole
  status      UserStatus      @default(PENDING)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  studentProfile StudentProfile?
  tutorProfile   TutorProfile?
}

model StudentProfile {
  id                String          @id @default(uuid())
  userId            String          @unique
  gradeLevel        String
  goals             String?
  preferredSubjects String[]
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]
  reviews  Review[]
}

model TutorProfile {
  id                       String          @id @default(uuid())
  userId                   String          @unique
  bio                      String?
  education                String?
  certificates             String[]
  yearsOfExperience        Int             @default(0)
  hourlyRateMin            Float?
  hourlyRateMax            Float?
  teachingModes            String[]
  city                     String?
  district                 String?
  verified                 Boolean         @default(false)
  trustScore               Float           @default(0)
  averageRating            Float           @default(0)
  totalCompletedBookings   Int             @default(0)
  totalReviews             Int             @default(0)
  moderationNote           String?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes  Class[]
  bookings Booking[]
  reviews  Review[]
}

model Subject {
  id          String   @id @default(uuid())
  name        String
  level       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  classes Class[]

  @@index([name])
}

model Class {
  id            String      @id @default(uuid())
  tutorId       String
  subjectId     String
  title         String
  description   String
  targetGrade   String?
  pricePerHour  Float
  locationType  LocationType
  city          String?
  district      String?
  status        ClassStatus @default(DRAFT)
  isDeleted     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tutor   TutorProfile @relation(fields: [tutorId], references: [id])
  subject Subject      @relation(fields: [subjectId], references: [id])
  bookings Booking[]

  @@index([subjectId, status])
  @@index([tutorId])
  @@index([city, district])
}

model Booking {
  id                     String        @id @default(uuid())
  classId                String
  studentId              String
  tutorId                String
  status                 BookingStatus @default(PENDING)
  isTrial                Boolean       @default(false)
  requestedHoursPerWeek  Int
  startDateExpected      DateTime
  noteFromStudent        String?
  cancelReason           String?
  cancelledBy            CancelledBy?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  class   Class         @relation(fields: [classId], references: [id])
  student StudentProfile @relation(fields: [studentId], references: [id])
  tutor   TutorProfile @relation(fields: [tutorId], references: [id])
  review  Review?

  @@index([studentId])
  @@index([tutorId])
  @@index([status])
}

model Review {
  id         String   @id @default(uuid())
  bookingId  String   @unique
  studentId  String
  tutorId    String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  booking Booking        @relation(fields: [bookingId], references: [id])
  student StudentProfile @relation(fields: [studentId], references: [id])
  tutor   TutorProfile   @relation(fields: [tutorId], references: [id])

  @@index([tutorId])
}
